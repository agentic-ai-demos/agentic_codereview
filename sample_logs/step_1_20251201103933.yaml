steps:
- description: Use 'get_function_context_for_project_mcp' tool to retrieve detailed
    context of the 'infer_auto_device_map' function from the repository. This includes
    locating the function definition, understanding its current behavior, parameters,
    and internal logic. This information is crucial to comprehend how the new 'reserve_max_layer'
    argument integrates and influences the existing code.
  name: step1
  tool_results: Results from the tool execution will provide the full function code,
    existing logic, and definitions relevant for understanding and evaluating the
    code changes.
  tools:
  - function: get_function_context_for_project_mcp
    name: get_function_context_for_project_mcp
    parameters:
      function_name: infer_auto_device_map
      github_repo: https://github.com/huggingface/accelerate
- description: Identify all references and call-sites of 'infer_auto_device_map' within
    the repository. This includes checking how the function is invoked elsewhere,
    especially those that do not set 'reserve_max_layer' explicitly, to ensure that
    the logic for re-invocation with 'reserve_max_layer=True' is sound and does not
    introduce regressions or unintended side effects.
  name: step2
  tool_results: Gathered references will help verify whether all call-sites properly
    handle the new parameter and if any calls need updates or additional checks.
  tools:
  - function: get_function_references_mcp
    name: get_function_references_mcp
    parameters:
      function_name: infer_auto_device_map
      github_repo: https://github.com/huggingface/accelerate
- description: Examine the code diff itself to review how the 'reserve_max_layer'
    argument is incorporated into the function. Check the logic that conditionally
    initializes 'max_layer_size' and 'max_layer_names' based on 'reserve_max_layer',
    especially in the main loop and nested calls. Assess whether the new logic maintains
    the intended behavior, handles edge cases (e.g., no layers left), and correctly
    triggers re-invocation for offloaded layers.
  name: step3
  tool_results: Analysis of the diff will verify the correctness and consistency of
    the new conditionals and logic modifications, ensuring they align with the function's
    purpose and do not introduce bugs.
  tools: []
- description: Evaluate the added handling for offloaded layers and device map re-computation
    when 'reserve_max_layer=False' and offloading is detected. Confirm that the recursive
    call with 'reserve_max_layer=True' functions as intended and that the overall
    logic correctly accounts for memory reservations, especially in multi-GPU or CPU
    offload scenarios.
  name: step4
  tool_results: This step ensures the robustness of the offloading management logic
    and proper recursion to handle complex memory layouts.
  tools: []
- description: Perform a code review focusing on the safety, readability, and maintainability
    of the new implementation. Check for proper handling of default values, potential
    infinite recursion, scenarios where 'max_layer_size' could be zero, and whether
    the logic gracefully handles cases with minimal or no residual layers.
  name: step5
  tool_results: Assessment of code quality, potential edge cases, and suggestions
    for improvement if necessary.
  tools: []
summary: This review plan aims to systematically analyze the code modifications introduced
  in the 'infer_auto_device_map' function by understanding the context, assessing
  the impact of the new 'reserve_max_layer' parameter, and verifying the overall correctness
  and consistency of the implementation. The steps involve extracting function details,
  examining related references, and inspecting the code diff to evaluate the correctness
  of the changes.
version: 1
