ai_generated_smell: true
breaking_change_risk: low
category: testing
code_snippet: Modified test_infer_auto_device_map to include reserve_max_layer parameter
  usages
cwe: N/A
file: tests/test_modeling_utils.py
fix:
  patch: '--- a/tests/test_modeling_utils.py

    +++ b/tests/test_modeling_utils.py

    @@ ... (entire test_infer_auto_device_map updates as shown)'
  strategy: Update tests to cover different reserve_max_layer configurations to ensure
    correct behavior.
follow_up:
- Validate that infer_auto_device_map() correctly implements reserve_max_layer logic.
- Add further edge case tests for large models and more complex tie scenarios.
lines: 555-902
migration_notes: Update or verify the implementation of infer_auto_device_map() to
  handle reserve_max_layer parameter as tested.
owasp_top10: N/A
references:
- Official infer_auto_device_map() documentation or code (if available)
root_cause: Previous tests did not account for reserve_max_layer, risking mismatch
  between test and implementation logic.
severity: high
tests:
  cases:
  - Basic device map with reserve_max_layer=True
  - Device allocation without reserve_max_layer
  - Models with tied weights under different reserve_max_layer settings
  - Models with offloaded modules and multi-device configurations
  new_or_changed:
  - test_infer_auto_device_map_reserve_max_layer
title: Tests now explicitly check reserve_max_layer parameter
why_it_matters: Ensures tests validate behavior conditioned on reserve_max_layer,
  aligning test expectations with actual code behavior.
